<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>{% if editar %}Editar usuário{% else %}Cadastrar usuário{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg" style="background: linear-gradient(90deg, #007bff, #6f42c1);">
  <div class="container-fluid">
    <a class="navbar-brand text-white" href="{% url 'usuarios' %}">Usuários</a>
    <span class="navbar-text text-white ms-3">
      {% if editar %}Editar{% else %}Cadastrar{% endif %}
    </span>
  </div>
</nav>

<div class="container my-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} py-2">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- action="" faz POST para a mesma URL (novo ou editar) -->
  <form action="" method="post" class="mx-auto mt-2 p-4 shadow rounded-3 bg-white" style="max-width: 520px;">
    {% csrf_token %}
    <div class="card p-4 shadow rounded-3">
      <h2 class="h4 mb-3">{% if editar %}Editar usuário{% else %}Cadastrar usuário{% endif %}</h2>

      <div class="mb-3">
        <label class="form-label">Usuário</label>
        <input type="text" name="nome" class="form-control" required value="{{ u.nome|default:'' }}">
      </div>

      <div class="mb-3">
        <label class="form-label">Idade</label>
        <input type="number" name="idade" class="form-control" required value="{{ u.idade|default:'' }}">
      </div>

      <div class="mb-3">
        <label class="form-label">E-mail</label>
        <input type="email" name="email" class="form-control" placeholder="ex: nome@dominio.com" value="{{ u.email|default:'' }}">
      </div>

      <div class="mb-3">
        <label class="form-label">Telefone</label>
        <input type="text" name="telefone" class="form-control" placeholder="(71) 99999-9999" value="{{ u.telefone|default:'' }}">
      </div>

      <div class="mb-3">
        <label class="form-label">CEP</label>
        <input type="text" name="cep" id="cep" class="form-control" placeholder="00000-000" maxlength="9" value="{{ u.cep|default:'' }}">
        <div class="form-text">Digite o CEP e saia do campo para buscar o endereço.</div>
      </div>

      <div class="mb-3">
        <label class="form-label">Logradouro</label>
        <input type="text" name="logradouro" id="logradouro" class="form-control" value="{{ u.logradouro|default:'' }}">
      </div>

      <div class="mb-3">
        <label class="form-label">Bairro</label>
        <input type="text" name="bairro" id="bairro" class="form-control" value="{{ u.bairro|default:'' }}" readonly>
      </div>

      <div class="mb-3">
        <label class="form-label">Cidade</label>
        <input type="text" name="cidade" id="cidade" class="form-control" value="{{ u.cidade|default:'' }}" readonly>
      </div>

      <div class="mb-3">
        <label class="form-label">UF</label>
        <input type="text" name="uf" id="uf" class="form-control" maxlength="2" value="{{ u.uf|default:'' }}" readonly>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-fill">Salvar</button>
        <a class="btn btn-outline-secondary flex-fill" href="{% url 'usuarios' %}">Cancelar</a>
      </div>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = (id) => document.getElementById(id);
  const cepEl = $('cep');
  const logEl = $('logradouro');
  const baiEl = $('bairro');
  const cidEl = $('cidade');
  const ufEl  = $('uf');

  async function getJSON(url) {
    const r = await fetch(url, { mode: 'cors' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function buscarCEP() {
    if (!cepEl) return;
    let cep = (cepEl.value || '').replace(/\D/g, '');
    if (cep.length !== 8) return;

    // Formata 00000-000
    cepEl.value = cep.replace(/(\d{5})(\d{3})/, '$1-$2');

    try {
      // ViaCEP
      const v = await getJSON(`https://viacep.com.br/ws/${cep}/json/`);
      if (v.erro) throw new Error('CEP não encontrado no ViaCEP');
      if (!logEl.value) logEl.value = v.logradouro || '';
      baiEl.value = v.bairro || '';
      cidEl.value = v.localidade || '';
      ufEl.value  = v.uf || '';
    } catch (e1) {
      console.warn('ViaCEP falhou:', e1);
      // Fallback CorreiosAPI
      try {
        const c = await getJSON(`https://correiosapi.apphb.com/cep/${cep}.json`);
        const logradouro = [c.tipoDeLogradouro, c.logradouro].filter(Boolean).join(' ');
        if (!logEl.value) logEl.value = logradouro || '';
        baiEl.value = c.bairro || '';
        cidEl.value = c.cidade || '';
        ufEl.value  = c.estado || '';
      } catch (e2) {
        console.error('CorreiosAPI falhou também:', e2);
        alert('Não foi possível buscar o CEP. Verifique e tente novamente.');
      }
    }
  }

  if (cepEl) {
    cepEl.addEventListener('blur', buscarCEP);
    cepEl.addEventListener('input', (e) => {
      const d = e.target.value.replace(/\D/g, '');
      if (d.length === 8) buscarCEP();
    });
  }
});
</script>
</body>
</html>
